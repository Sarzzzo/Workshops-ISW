<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Add Books</title>

  <!-- Bootstrap para estilos -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>

<section>
  <div class="container">
    <h1 class="mt-4">Add new book</h1>
    <div class="form-contact-info mb-3">
      <div class="error_msg text-danger mb-2" id="error_msg"></div>
      <form id="book-form">
        <input type="text" class="form-control mb-2" name="title" placeholder="Type book title" id="title" />
        <select name="author" id="authors-list" class="form-control mb-2"></select>
        <input type="button" value="Add" id="add-book-button" class="btn btn-primary" />
        <p class="alrUser mt-2">¿No hay autores? <a href="addAuthor.html">Insertar</a></p>
      </form>
    </div>

    <!-- Tabla de libros -->
    <h2>Book List</h2>
    <table id="books-table" class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Author</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llena dinámicamente -->
      </tbody>
    </table>
  </div>
</section>

<script>
  let editingBookId = null; // Para saber si estamos editando

  // Cargar autores al select
  function loadAuthors() {
    const authors = JSON.parse(localStorage.getItem('authors')) || [];
    if (authors.length > 0) {
      let options = '<option disabled selected value="">Select an author</option>';
      authors.forEach(author => {
        options += `<option value="${author.id}">${author.name}</option>`;
      });
      $('#authors-list').html(options);
    } else {
      $('#authors-list').html('<option disabled>No authors found</option>');
    }
  }

  // Cargar libros en la tabla
  function loadBooks() {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const authors = JSON.parse(localStorage.getItem('authors')) || [];
    const tbody = $('#books-table tbody');
    tbody.empty();

    books.forEach(book => {
      const author = authors.find(a => a.id === book.authorId);
      const authorName = author ? author.name : 'Unknown';
      const row = `
        <tr>
          <td>${book.id}</td>
          <td>${book.name}</td>
          <td>${authorName}</td>
          <td>
            <span class="action-link edit-link" data-id="${book.id}">Edit</span>
            <span class="action-link delete-link" data-id="${book.id}">Delete</span>
          </td>
        </tr>
      `;
      tbody.append(row);
    });

    // Asignar eventos a los botones Edit y Delete
    $('.edit-link').click(function () {
      const id = parseInt($(this).data('id'));
      startEditBook(id);
    });

    $('.delete-link').click(function () {
      const id = parseInt($(this).data('id'));
      deleteBook(id);
    });
  }

  // Agregar o actualizar un libro
  function addOrUpdateBook() {
    const title = $('#title').val().trim();
    const authorId = parseInt($('#authors-list').val());

    if (!title || isNaN(authorId)) {
      $('#error_msg').text('Please fill in all fields.');
      return;
    } else {
      $('#error_msg').text('');
    }

    let books = JSON.parse(localStorage.getItem('books')) || [];

    if (editingBookId) {
      // Modo edición
      books = books.map(book =>
        book.id === editingBookId ? { ...book, name: title, authorId: authorId } : book
      );
      editingBookId = null;
      $('#add-book-button').val('Add');
    } else {
      // Modo agregar
      const newId = books.length > 0 ? Math.max(...books.map(b => b.id)) + 1 : 1;
      books.push({ id: newId, name: title, authorId: authorId });
    }

    // Guardar y refrescar
    localStorage.setItem('books', JSON.stringify(books));
    $('#title').val('');
    $('#authors-list').val('');
    loadBooks();
  }

  // Empezar a editar un libro
  function startEditBook(id) {
    const books = JSON.parse(localStorage.getItem('books')) || [];
    const book = books.find(b => b.id === id);
    if (!book) return;

    $('#title').val(book.name);
    $('#authors-list').val(book.authorId);
    $('#add-book-button').val('Update');
    editingBookId = book.id;
  }

  // Eliminar un libro por ID
  function deleteBook(id) {
    let books = JSON.parse(localStorage.getItem('books')) || [];
    books = books.filter(book => book.id !== id);
    localStorage.setItem('books', JSON.stringify(books));
    loadBooks();
  }

  // Cuando el DOM esté listo
  $(document).ready(function () {
    loadAuthors();
    loadBooks();
    $('#add-book-button').click(addOrUpdateBook);
  });
</script>

</body>
</html>
